---
alwaysApply: true
---

# Pixel Refiner Cursor Rules

## Project Overview
This project is a Web tool for optimizing pixel art (pixel art) created by AI generation, etc.
It uses TypeScript (Vanilla), Vite, and Vitest, and does not use UI frameworks (React/Vue, etc.).

## Technology Stack
- **Language:** TypeScript (Strict mode)
- **Build Tool:** Vite
- **Testing:** Vitest
- **Linter/Formatter:** Biome (Prettier for HTML)
- **CSS:** Standard CSS (utilizing Variables)
- **Architecture:** Separation of Core Logic (`src/core`) and UI Logic (`src/browser`)

## Directory Structure and Responsibilities
- `src/core/`: Pure logic for image processing.
    - **Rule:** Avoid dependencies on DOM APIs (`document`, `window`, `HTMLCanvasElement`, etc.). Focus on data structures like `RawImage` (`Uint8ClampedArray`).
- `src/browser/`: UI manipulation, DOM events, Canvas rendering.
    - **Rule:** Call functions from `src/core` to perform processing. DOM manipulation should only be done here.
- `src/shared/`: Type definitions (`types.ts`) and constant configurations (`config.ts`).

## Coding Conventions

### TypeScript & Style
- **Type Definitions:** usage of `any` is strictly prohibited. Actively use types like `RawImage`, `PixelGrid` in `src/shared/types.ts`.
- **Array Operations:** Treat pixel data as `Uint8ClampedArray` (1D array). Maintain the order `[r, g, b, a]`.
- **Loops:** Be conscious of performance in image processing (`src/core`). Use `for` loops instead of higher-order functions (map/filter) in performance-critical sections.
- **Null Safety:** Utilize Optional Chaining (`?.`) and Nullish Coalescing (`??`).
- **Formatting:** Follow Biome settings (tab indentation, with semicolons).

### Image Processing Logic (src/core)
- Aggregate basic pixel operations (getPixel, setPixel, posterize, etc.) in `src/core/ops.ts`.
- Design functions to be side-effect free (receive input `RawImage` and return a new `RawImage` or analysis result).
- Use index calculation `x + y * width` for coordinate calculations.

### UI Implementation (src/browser)
- Since no UI framework is used, use `document.getElementById` or `querySelector`.
- Retrieve elements through type-safe functions, like the `getElements` helper pattern in `app.ts`.
- Manage state with local variables or closures within `app.ts`.
- **i18n:** When adding or changing `data-i18n` or `data-i18n-attr` attributes in HTML, always register corresponding translation keys in **both `ja` and `en`** sections of `src/browser/i18n.ts`. Forgetting to register keys will cause raw key strings (e.g. `setting.xxx`) to be displayed in the UI.

### Testing (Vitest)
- Write logic tests in `src/core/*.test.ts`.
- Recommended to check processing results by reading actual image files (`test/fixtures`).
- Use `pngjs` to assist with image I/O for testing.

### Commit Messages (Compliant with SKILL.md)
- **Language:** English
- **Format:** `<type>: <description>` (e.g., `feat: improve grid detection algorithm`)
- **Type List:**
    - `feat`: New feature
    - `fix`: Bug fix
    - `docs`: Documentation
    - `style`: Formatting, etc.
    - `refactor`: Refactoring
    - `perf`: Performance improvement
    - `test`: Test related
    - `chore`: Tooling, etc.

## Code Generation Guidelines

### When Modifying/Adding Code
1. Adhere to the separation principle of existing `src/core` and `src/browser`.
2. Add new types to `src/shared/types.ts` if necessary.
3. Do not hardcode configuration values; use/update `PROCESS_RANGES` or `PROCESS_DEFAULTS` in `src/shared/config.ts`.
4. Write description comments (JSDoc, etc.) in English.
5. **Always run `make ci` after code changes to ensure linter checks and tests pass.**

### Performance Considerations
- Be aware of the copy cost of `Uint8ClampedArray`.
- Avoid unnecessary creation of `new Uint8ClampedArray` or `new ImageData`.
- Avoid object creation inside large loops.

## Important Files/Constants
- `src/shared/types.ts`: `RawImage` type definition
- `src/core/processor.ts`: Main pipeline for image processing
- `Makefile`: Consider that `make ci` runs Biome check and tests
